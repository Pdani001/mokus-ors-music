<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mókus Őrs</title>
    <link rel="icon" type="image/png" href="icon.png">
    <!-- # BOOTSTRAP / JQUERY # -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js" integrity="sha384-qKXV1j0HvMUeCBQ+QVp7JcfGl760yU08IQ+GpUo5hlbpg51QRiuqHAJz8+BrxE/N" crossorigin="anonymous" defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <!-- # CUSTOM # -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script>
        if(!Cookies.get("token")){
            window.location = "./login.html";
        }
    </script>
    <script>
        function setRepeatMode(mode){
            switch(mode){
                case 0:
                    $("#repeat").removeClass("active");
                    $("#repeat .bi").addClass("bi-repeat")
                                    .removeClass("bi-robot")
                                    .removeClass("bi-repeat-1");
                    break;
                case 1:
                    $("#repeat").addClass("active");
                    $("#repeat .bi").removeClass("bi-repeat")
                                    .removeClass("bi-robot")
                                    .addClass("bi-repeat-1");
                                break;
                case 2:
                    $("#repeat").addClass("active");
                    $("#repeat .bi").removeClass("bi-repeat-1")
                                    .removeClass("bi-robot")
                                    .addClass("bi-repeat");
                    break;
                case 3:
                    $("#repeat").addClass("active");
                    $("#repeat .bi").removeClass("bi-repeat-1")
                                    .removeClass("bi-repeat")
                                    .addClass("bi-robot");
                    break;
                default:
                    // Invalid repeat mode, ignore
                    return;
            }
            $("#repeat").data("mode",mode);
        }

        function updateTime(){
            let totalSeconds = !countdown ? Math.floor(Number($("#time").data("playback")) / 1000) : Math.floor((Number($("#time").data("duration"))-Number($("#time").data("playback")))/1000);
            if(totalSeconds < 0)
                totalSeconds = 0;
            const totalMinutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const secondsText = String(seconds).padStart(2, "0");
            const minutesText = String(minutes).padStart(2, "0");
            const hoursText = hours > 0 ? String(hours).padStart(2, "0") + ":" : "";
            $("#time").text((countdown?"-":"")+hoursText+minutesText+":"+secondsText);
        }

        let lastUrl = "";
        let lastTitle = "";
        let isStopped = true;
        let countdown = false;
        let BulkMode = false;
        const _GET = Object.fromEntries(new URLSearchParams(window.location.search).entries());
        let CurrentFolder = _GET.folder || "";
        let ParentFolder = "";
        let ChannelList = [];
        let LastEvent = null;

        function showToast(title, message){
            $("#wsToast").find(".toast-body").text(message);
            $("#wsToast").find(".header-text").text(title);
            $("#wsToast").toast({autohide: false});
            $("#wsToast").toast('show');
        }

        const ws = new WebSocket("wss://mokus.pghost.org/music", "echo-protocol");
        ws.onopen = function(e) {
            console.log("WebSocket is open\n",ws);
            ws.send(JSON.stringify({
                event: "getGlobal"
            }))
        }
        ws.onclose = function(e) {
            console.log("WebSocket closed:\n", e);
            if(e.code == 1001)
                return;
            showToast("WebSocket error","Megszakadt a kapcsolat a WebSocket szerverrel! Újracsatlakozás folyamatban...");
            setInterval(()=>{
                const ws = new WebSocket("wss://mokus.pghost.org/music", "echo-protocol");
                ws.onopen = function(e) {
                    $("#wsToast").toast("hide");
                    console.log("WebSocket is open, reloading...");
                    window.location = "./list.html";
                }
            },10000);
        }
        ws.onerror = function(e) {
            console.log("WebSocket error:\n", e);
            showToast("WebSocket error","Hiba lépett fel a WebSocket kapcsolatban!");
        }
        ws.onmessage = function(msg) {
            const data = JSON.parse(msg.data);
            if(data.error){
                console.error(data);
            }
            const event = data.event || "";
            if(event == "refresh"){
                if(data.music.duration != 0){
                    $(".progress-bar").css("width",((data.music.playback/data.music.duration)*100)+"%");
                } else {
                    $(".progress-bar").css("width","100%");
                }

                $("#time").data("playback",data.music.playback);
                $("#time").data("duration",data.music.duration);
                updateTime();
                
                isStopped = data.music.stopped;

                $("#stop").toggle(!isStopped);

                if(lastTitle != data.music.title){
                    let img = "";
                    $(".playback .trackInfo").find(".thumbnail").remove();
                    if(data.music.thumbnail != null && data.music.thumbnail != ""){
                        img = `<img src="${data.music.thumbnail}" class="thumbnail">`;
                        $(".playback .trackInfo").prepend($(img));
                    }
                    $("#trackName").html(`<a href="${data.music.url}" target="_blank" rel="noopener noreferrer" class="link-dark" title="${data.music.title}">${data.music.title}</a>`);
                    lastUrl = data.music.url;
                    lastTitle = data.music.title;
                }
                if(data.music.paused){
                    $("#toggle .bi").removeClass("bi-pause-fill").addClass("bi-play-fill");
                } else {
                    $("#toggle .bi").removeClass("bi-play-fill").addClass("bi-pause-fill");
                }
                return;
            }
            if(event == "volume"){
                $("#volume").val(data.volume);
                return;
            }
            if(event == "repeatMode"){
                setRepeatMode(data.repeat);
            }
            if(event == "listQueue"){
                $("#queue-page .list-content").html("");
                let index = 1;
                const table = $(`<table class="table table-striped table-hover"></table>`);
                const thead = $.parseHTML(
                    `<thead>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th>Title</th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>`
                    );
                table.append(thead);
                const tbody = $(`<tbody class="sortable"></tbody>`);
                data.queue.forEach(track=>{
                    let img = "";
                    if(track.thumbnail != null && track.thumbnail != ""){
                        img = `<img src="${track.thumbnail}" width="30" height="30">`;
                    }
                    const row = $.parseHTML(
                        `<tr class="trackInfo draggable" data-id="${index-1}">
                            <td width="1"></td>
                            <td width="30">${img}</td>
                            <td width="35">
                                <span class="trackIndex">${index++}</span>
                                <span class="trackPlay bi bi-play-fill"></span>
                            </td>
                            <td class="trackName" title="${track.title}">${track.title}</td>
                            <td width="1"></td>
                            <td width="1">${track.duration}</td>
                            <td width="1"><span class="removeQueue bi bi-x-lg"></span></td>
                        </tr>`
                    );
                    tbody.append(row);
                });
                table.append(tbody);
                if(index > 1){
                    $("#queue-page .list-content").append(table);
                    //$("#queue-page .list-content .draggable").draggable({ revert: true, containment: ".page-content" });
                    $("#queue-page .list-content .sortable").sortable({
                        containment: ".page-content",
                        scrollSensitivity: 100,
                        scrollSpeed: 100,
                        update: function(event, ui){
                            if($("#search").val() != ""){
                                event.preventDefault();
                                return true;
                            }
                            const item = $(ui.item);
                            const oldIndex = Number(item.data("id"));
                            const newIndex = item.index();
                            ws.send(JSON.stringify({
                                event: 'sortQueue',
                                oldIndex: oldIndex,
                                newIndex: newIndex
                            }));
                        }
                    });
                    $("#search").trigger("keyup");
                } else {
                    const alert = $.parseHTML(
                        `<div class="alert alert-info">The queue is empty.</div>`
                    );
                    $("#queue-page .list-content").append(alert);
                }
            }
            if(event == "listSaved"){
                ParentFolder = data.parent;
                $("#saved-page .list-content").html("");
                let index = 1;
                const table = $(`<table class="table table-striped table-hover${BulkMode ? " bulk-mode" : ""}"></table>`);
                const thead = $.parseHTML(
                    `<thead>
                        <tr>
                            <th><input class="form-check-input trackSelect" type="checkbox" id="mainSelect"></th>
                            <th></th>
                            <th></th>
                            <th>Title</th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>`
                    );
                table.append(thead);
                const tbody = $(`<tbody class="sortable"></tbody>`);
                if(CurrentFolder != ""){
                    index++;
                    const row = $.parseHTML(
                        `<tr class="trackInfo droppable" data-id="${ParentFolder}" data-type="folder">
                            <td width="1"></td>
                            <td width="30"></td>
                            <td width="35">
                                <span class="folderIndex bi bi-folder2-open"></span>
                            </td>
                            <td>..</td>
                            <td width="1"></td>
                            <td width="1"></td>
                            <td width="1"></td>
                        </tr>`
                    );
                    tbody.append(row);
                }
                data.saved.filter(track => track.type == "folder").forEach(track=>{
                    index++;
                    const row = $.parseHTML(
                        `<tr class="trackInfo draggable droppable" data-id="${track.id}" data-type="${track.type}">
                            <td width="1"><input class="form-check-input trackSelect" type="checkbox"></td>
                            <td width="30"></td>
                            <td width="35">
                                <span class="folderIndex bi bi-folder2-open"></span>
                            </td>
                            <td class="trackName">${track.name}</td>
                            <td width="1">
                                <div class="dropdown">
                                    <span class="bi bi-three-dots-vertical trackDropdown" data-bs-toggle="dropdown"></span>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item trackEdit" href="#">Edit</a></li>
                                    </ul>
                                </div>
                            </td>
                            <td width="1"></td>
                            <td width="1"><span class="removeSaved bi bi-x-lg"></span></td>
                        </tr>`
                    );
                    tbody.append(row);
                });
                data.saved.filter(track => track.type == "url").forEach(track=>{
                    let img = "";
                    if(track.info.thumbnail != null && track.info.thumbnail != ""){
                        img = `<img src="${track.info.thumbnail}" width="30" height="30">`;
                    }
                    const row = $.parseHTML(
                        `<tr class="trackInfo draggable" data-id="${track.id}" data-type="${track.type}">
                            <td width="1"><input class="form-check-input trackSelect" type="checkbox"></td>
                            <td width="30">${img}</td>
                            <td width="35">
                                <span class="trackIndex">${index++}</span>
                                <span class="trackPlay bi bi-play-fill" data-query="${track.info.url}"></span>
                            </td>
                            <td class="trackName">${track.name}</td>
                            <td width="1">
                                <div class="dropdown">
                                    <span class="bi bi-three-dots-vertical trackDropdown" data-bs-toggle="dropdown"></span>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item trackEdit" href="#">Edit</a></li>
                                        <li><a class="dropdown-item trackEnqueue" href="#">Enqueue</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item copyTrackUrl" href="#">Copy URL</a></li>
                                    </ul>
                                </div>
                            </td>
                            <td width="1">${track.info.duration}</td>
                            <td width="1"><span class="removeSaved bi bi-x-lg"></span></td>
                        </tr>`
                    );
                    tbody.append(row);
                });
                table.append(tbody);
                if(index > 1){
                    $("#saved-page .list-content").append(table);
                    $("#saved-page .list-content .draggable").draggable({ revert: true, containment: ".page-content", disabled: !BulkMode });
                    $("#saved-page .list-content .droppable").droppable({
                        drop: function(event, ui){
                            if($("#search").val() != "")
                                return true;
                            const boxes = $(".trackSelect:not(#mainSelect)").filter((i,e)=>{return $(e).prop("checked");});
                            let target = $(this).data("id");
                            if(boxes.length <= 1){
                                const dragged = $(ui.draggable).data("id");
                                ws.send(JSON.stringify({
                                    event: 'sortSaved',
                                    file: dragged,
                                    newParent: target
                                }));
                            } else {
                                let list = [];
                                for (const b of boxes) {
                                    const parent = $($(b).parents(".trackInfo"));
                                    list.push(parent.data("id"));
                                }
                                ws.send(JSON.stringify({
                                    event: 'sortSaved',
                                    file: list,
                                    newParent: target
                                }));
                            }
                        }
                    });
                    $("#search").trigger("keyup");
                } else {
                    const alert = $.parseHTML(
                        `<div class="alert alert-info">There are no saved musics.</div>`
                    );
                    $("#saved-page .list-content").append(alert);
                }
            }
            if(event == "getGlobal"){
                ws.send(JSON.stringify({
                    event: "listSaved",
                    folder: CurrentFolder
                }));
                ChannelList = data.channels;
                $("#volume").val(data.volume);
                $("#volume").triggerHandler("start:update");
                setRepeatMode(data.repeat);
                if($("#time").data("playback") == undefined){
                    $("#time").data("playback",0);
                    $("#time").data("duration",0);
                }
            }
            if(event == "listChannels"){
                $("#selectChannelGroup").hide();
                $("#selectChannelSubmit").prop("disabled",true);
                $("#selectServerInput").html(`<option value="" selected disabled>Select a server</option>`);
                for (let index = 0; index < ChannelList.length; index++) {
                    const server = ChannelList[index];
                    $("#selectServerInput").append($(`<option value="${index}">${server.name}</option>`));
                }
                const show = data.show || false;
                if(show)
                    $("#selectChannelModal").modal("show");
            }
            if(event == "sortSaved" || event == "save" || event == "trackEdit"){
                if(data.error){
                    alert(data.error);
                    return;
                }
                ws.send(JSON.stringify({
                    event: "listSaved",
                    folder: CurrentFolder
                }));
            }
        }

        $(function(){
            $("#stop").toggle(!isStopped);

            $('body').on('click',`a[href="#"]`,function(e){
                e.preventDefault();
            });

            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

            $("#volume").on("change",function(){
                ws.send(JSON.stringify({
                    event: "volume",
                    volume: $(this).val()
                }));
            });

            $("#logout").click(function(){
                Cookies.remove("token");
                window.location = "./login.html";
            });
            $("#toggle").click(function(){
                if(!isStopped){
                    ws.send(JSON.stringify({
                        event: "pause",
                        toggle: $("#toggle .bi").hasClass("bi-pause-fill")
                    }));
                    return;
                }
                if(lastUrl == ""){
                    return;
                }
                const event = {
                    event: "play",
                    query: lastUrl
                };
                LastEvent = event;
                ws.send(JSON.stringify(event));
            });
            $("#stop").click(function(){
                ws.send(JSON.stringify({
                    event: "stop"
                }));
                $("#toggle .bi").removeClass("bi-pause-fill").addClass("bi-play-fill");
            });
            $("#refresh").click(function(){
                ws.send(JSON.stringify({
                    event: "listChannels"
                }));
            });
            $("#skip").click(function(){
                ws.send(JSON.stringify({
                    event: "skip"
                }));
                $("#toggle .bi").removeClass("bi-pause-fill").addClass("bi-play-fill");
            });
            $("#back").click(function(){
                ws.send(JSON.stringify({
                    event: "skip",
                    back: true
                }));
                $("#toggle .bi").removeClass("bi-pause-fill").addClass("bi-play-fill");
            });
            $("#shuffle").click(function(){
                ws.send(JSON.stringify({
                    event: "shuffle"
                }));
            });
            $("#repeat").click(function(){
                if($(this).data("mode") == undefined)
                    return;
                let next = Number($(this).data("mode"))+1;
                if(next > 2)
                    next = 0;
                ws.send(JSON.stringify({
                    event: "repeatMode",
                    repeat: next
                }));
            });

            $("#time").click(function(){
                countdown = !countdown;
                updateTime();
            });
            $("#toggleBulkMode").click(function(){
                if(BulkMode){
                    $(".list-content .table").removeClass("bulk-mode");
                    $("#saved-page .list-content .draggable").draggable("disable");
                    $(".trackSelect").prop("checked",false);
                    lastChecked = null;
                } else {
                    $(".list-content .table").addClass("bulk-mode");
                    $("#saved-page .list-content .draggable").draggable("enable");
                }
                BulkMode = !BulkMode;
            });

            $('#seeker').click(function (e) {
                var posX = $(this).position().left,
                    posY = $(this).position().top;
                const click = (e.pageX - posX);
                const width = $(this).width();
                ws.send(JSON.stringify({
                    event: "seek",
                    percent: (click/width)
                }));
            });

            $(`.nav > .nav-link`).on("shown.bs.tab",function(event){
                const target = $(event.target).data("bsTarget");
                $(target+" .list-content").html("");
                if(target == "#queue-page"){
                    ws.send(JSON.stringify({
                        event: "listQueue"
                    }));
                } else {
                    ws.send(JSON.stringify({
                        event: "listSaved",
                        folder: CurrentFolder
                    }));
                }
            });

            $("#queue-page").on("click",".trackPlay",function () {
                const parent = $($(this).parents(".trackInfo"));
                const ID = Number(parent.data("id"));
                ws.send(JSON.stringify({
                    event: "play",
                    at: ID
                }));
            });
            $("#queue-page").on("click",".removeQueue",function () {
                const parent = $($(this).parents(".trackInfo"));
                const ID = Number(parent.data("id"));
                ws.send(JSON.stringify({
                    event: "queue",
                    remove: ID
                }));
            });

            $("#saved-page").on("dblclick",".trackInfo",function () {
                const type = $(this).data("type");
                const id = $(this).data("id");
                if(type == "folder"){
                    $(this).find(".folderIndex").click();
                }
                if(type == "url"){
                    $(this).find(".trackPlay").click();
                }
            });
            $("#saved-page").on("click",".folderIndex",function () {
                $("#saved-page .list-content").html("");
                const parent = $($(this).parents(".trackInfo"));
                CurrentFolder = parent.data("id");
                window.history.pushState({ "OldFolder": CurrentFolder },"","https://mokus.pghost.org/list.html?folder="+CurrentFolder);
                ws.send(JSON.stringify({
                    event: "listSaved",
                    folder: CurrentFolder
                }));
            });
            window.onpopstate = function(e){
                const old = Object.fromEntries(new URLSearchParams(e.target.location.search).entries())['folder'] || "";
                CurrentFolder = old;
                ws.send(JSON.stringify({
                    event: "listSaved",
                    folder: CurrentFolder
                }));
            };
            
            $("#saved-page").on("click",".trackPlay",function () {
                const query = $(this).data("query");
                const event = {
                    event: "play",
                    query: query
                };
                LastEvent = event;
                ws.send(JSON.stringify(event));
            });
            $("#saved-page").on("click",".removeSaved",function () {
                const boxes = $(".trackSelect:not(#mainSelect)").filter((i,e)=>{return $(e).prop("checked");});
                if(boxes.length <= 1){
                    const parent = $($(this).parents(".trackInfo"));
                    const ID = parent.data("id");
                    const type = parent.data("type");
                    if(confirm(`Are you sure you want to remove this ${type}?`)){
                        ws.send(JSON.stringify({
                            event: 'save',
                            folder: type == "folder",
                            remove: ID
                        }));
                    }
                } else {
                    let list = [];
                    for (const b of boxes) {
                        const parent = $($(b).parents(".trackInfo"));
                        const data = {
                            id: parent.data("id"),
                            type: parent.data("type")
                        }
                        list.push(data);
                    }
                    if(confirm(`Are you sure you want to remove these ${list.length} files?`)){
                        ws.send(JSON.stringify({
                            event: 'save',
                            remove: list
                        }));
                    }
                }
            });
            $("#saved-page").on("click","#playFolder",function () {
                const event = {
                    event: "playFolder",
                    folder: CurrentFolder
                };
                LastEvent = event;
                ws.send(JSON.stringify(event));
            });
            $("#saved-page").on("click","#mainSelect",function () {
                $(".trackSelect").prop("checked",$(this).prop("checked"));
            });

            var lastChecked = null;
            
            $("#saved-page").on("click",".trackSelect:not(#mainSelect)",function (e) {
                if (!lastChecked) {
                    lastChecked = this;
                    return;
                }
                const boxes = $(".trackSelect:not(#mainSelect)");

                if (e.shiftKey) {
                    var start = boxes.index(this);
                    var end = boxes.index(lastChecked);

                    boxes.slice(Math.min(start,end), Math.max(start,end)+ 1).prop('checked', lastChecked.checked);

                    document.getSelection().removeAllRanges();
                }

                const unchecked = boxes.filter(function(index){
                    return !$(this).prop("checked");
                });
                $("#mainSelect").prop("checked",unchecked.length == 0);

                lastChecked = this;
            });

            $("#search").on("keyup", function() {
                const value = $(this).val().toLowerCase();
                $(".list-content .trackInfo").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });

            $("#saved-page").on('click','.trackEnqueue', function(){
                const boxes = $(".trackSelect:not(#mainSelect)").filter((i,e)=>{return $(e).prop("checked");});
                if(boxes.length <= 1){
                    const query = $($(this).parents(".trackInfo")).find(".trackPlay").data("query");
                    const event = {
                        event: 'queue',
                        add: query
                    };
                    LastEvent = event;
                    ws.send(JSON.stringify(event));
                } else {
                    const tracks = [];
                    for (const b of boxes) {
                        tracks.push($($(b).parents(".trackInfo")).find(".trackPlay").data("query"));
                    }
                    const event = {
                        event: 'queue',
                        add: tracks
                    };
                    LastEvent = event;
                    ws.send(JSON.stringify(event));
                }
            });

            $("#saved-page").on('click','.copyTrackUrl', function(){
                const query = $($(this).parents(".trackInfo")).find(".trackPlay").data("query");
                navigator.clipboard.writeText(query);
            });
        });
    </script>
    <style>
        .navbar .nav-link {
            padding-top: 15px;
            padding-bottom: 15px;
            padding-right: var(--bs-navbar-nav-link-padding-x);
            padding-left: var(--bs-navbar-nav-link-padding-x);
        }
        .navbar .nav-link.active, .nav .nav-link.active {
            --bs-bg-opacity: 1;
            background-color: rgba(var(--bs-secondary-bg-rgb),var(--bs-bg-opacity)) !important;
        }
        .navbar-collapse {
            padding-top: 10px;
        }
        .page-content {
            margin-top: 70px;
            margin-bottom: 200px;
        }
        @media (min-width: 992px){
            .navbar-expand-lg .navbar-collapse {
                display: flex !important;
                flex-basis: auto;
                padding-top: 0;
            }
            .page-content {
                margin-top: 80px;
            }
        }
        @media (min-width: 768px) {
            .page-content {
                margin-bottom: 60px;
            }
        }

        .btn .hide-sm {
            display: none;
        }
        @media (min-width: 768px) {
            .btn .hide-sm {
                display: initial;
            }
        }

        .list-content .trackInfo:not(:hover) .trackPlay,
        .list-content .trackInfo:not(:hover) .trackDropdown
        {
            display: none;
        }
        .list-content .trackInfo:hover .trackIndex {
            display: none;
        }
        .list-content .trackInfo .trackName {
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            max-width: 1px;
        }
        .list-content .trackInfo.ui-sortable-helper .trackName,
        .list-content .trackInfo.ui-draggable-dragging .trackName
        {
            max-width: none;
            width: 100%;
        }

        .list-content .table:not(.bulk-mode) td:first-child, .list-content .table:not(.bulk-mode) th:first-child {
            display: none;
        }


        .playback {
            min-height: 60px;
        }
        .playback > .row {
            min-height: 60px;
        }

        .progress {
            position: absolute;
            top: -8px;
            left: 0px;
            right: 0px;
            height: 8px;
        }
        #seeker {
            position: absolute;
            left: 0;
            right: 0;
            top: -5px;
            bottom: -5px;
            cursor: pointer;
        }

        .playback .trackInfo .thumbnail {
            float: left;
            height: 60px;
            width: 60px;
            margin-left: calc(var(--bs-gutter-x) * -.5);
            margin-right: calc(var(--bs-gutter-x) * .5);
        }
        #trackName {
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            margin-top: .7rem;
        }

        .controls {
            margin-top: .7rem;
        }
        .controls > .row {
            height: 100%;
        }
        .controls .controller, #time, .removeQueue, .trackPlay, .trackDropdown, .folderIndex, .removeSaved {
            cursor: pointer;
        }
        .controls .controller:hover {
            color: var(--bs-primary-text-emphasis);
        }
        .controls .controller.active {
            color: var(--bs-primary);
        }

        #volume {
            height: 100%;
        }
        #time {
            margin-top: .7rem;
        }
    </style>
</head>
<body>
    <nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
          <a class="navbar-brand" href="/">Mókus Őrs</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="list.html">Music</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="settings.html">Settings</a>
              </li>
            </ul>
            <form class="d-flex" role="search">
              <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" id="search">
            </form>
            <button class="btn btn-secondary me-1" aria-label="Refresh channels" id="refresh" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Refresh channels">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button class="btn btn-danger me-1" aria-label="Stop" id="stop" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Stop">
                <i class="bi bi-stop-fill"></i>
            </button>
            <button class="btn btn-primary" aria-label="Logout" id="logout" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Logout">
                <i class="bi bi-box-arrow-right"></i>
            </button>
          </div>
        </div>
    </nav>

    <div class="container-fluid page-content">
        <div class="row">
            <div class="col-md-2 mb-2">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" data-bs-toggle="tab" data-bs-target="#saved-page">Saved</a>
                    <a class="nav-link" href="#" data-bs-toggle="tab" data-bs-target="#queue-page">Queue</a>
                </nav>
            </div>
            <div class="col-md-10">
                <div class="tab-content">
                    <div class="tab-pane active" id="saved-page">
                        <div class="float-end text-end my-2">
                            <button class="btn btn-sm btn-primary" id="addSaved"><i class="bi bi-link-45deg"></i> <span class="hide-sm">Add URLs</span></button>
                            <button class="btn btn-sm btn-primary" id="addFolder"><i class="bi bi-folder-plus"></i> <span class="hide-sm">Add Folder</span></button>
                            <button class="btn btn-sm btn-success" id="playFolder" title="Play folder"><i class="bi bi-play-fill"></i></button>
                            <button class="btn btn-sm btn-info" id="toggleBulkMode" title="Bulk Mode"><i class="bi bi-list-check"></i></button>
                        </div>
                        <h1>Saved music</h1>
                        <div class="list-content"></div>
                    </div>
                    <div class="tab-pane" id="queue-page">
                        <div class="float-end text-end my-2">
                            <button class="btn btn-sm btn-primary" id="addQueue"><i class="bi bi-link-45deg"></i> <span class="hide-sm">Add URL</span></button>
                            <button class="btn btn-sm btn-danger" id="clearQueue"><i class="bi bi-trash-fill"></i> <span class="hide-sm">Clear Queue</span></button>
                        </div>
                        <h1>Queue</h1>
                        <div class="list-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid playback fixed-bottom bg-light text-dark">
        <div class="progress" role="progressbar">
            <div class="progress-bar" style="width: 0%"></div>
            <div id="seeker"></div>
        </div>

        <div class="row">
            <div class="col-md-4 col-xl-5 trackInfo">
                <h3 id="trackName">...</h3>
            </div>
            <div class="col-md-4 col-xl-3 text-center controls">
                <div class="row">
                    <div class="col"><h3 class="controller" id="repeat"><i class="bi bi-repeat"></i></h3></div>
                    <div class="col"><h3 class="controller" id="back"><i class="bi bi-skip-backward-fill"></i></h3></div>
                    <div class="col"><h3 class="controller" id="toggle"><i class="bi bi-play-fill"></i></h3></div>
                    <div class="col"><h3 class="controller" id="skip"><i class="bi bi-skip-forward-fill"></i></h3></div>
                    <div class="col"><h3 class="controller" id="shuffle"><i class="bi bi-shuffle"></i></h3></div>
                </div>
            </div>
            <div class="col-md-2 col-xl-2 range-wrap">
                <input type="range" class="form-range align-baseline" id="volume" min="0" max="100" step="1" value="10">
                <output class="bubble"></output>
            </div>
            <div class="col-md-2 col-xl-2">
                <h3 class="float-end" id="time">00:00</h3>
            </div>
        </div>
    </div>

    <style>
        .range-wrap {
            position: relative;
        }
        .bubble {
            background: var(--bs-secondary);
            color: white;
            padding: 4px 12px;
            position: absolute;
            border-radius: 4px;
            left: 50%;
            transform: translateX(-50%);
            top: -20px;
        }
        .bubble::after {
            content: "";
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--bs-secondary);
            bottom: -1px;
            left: 50%;
        }
    </style>
    <script>
        const allRanges = document.querySelectorAll(".range-wrap");
        allRanges.forEach(wrap => {
            const range = wrap.querySelector(".form-range");
            const bubble = wrap.querySelector(".bubble");

            $(range).one("start:update", () => {
                setBubble(range, bubble);
            });
            range.addEventListener("input", () => {
                setBubble(range, bubble);
            });
            range.addEventListener("mousedown", () => {
                showBubble(bubble, true);
            });
            range.addEventListener("mouseup", () => {
                showBubble(bubble, false);
            });
            showBubble(bubble, false);
            setBubble(range, bubble);
        });
        function setBubble(range, bubble) {
            const val = range.value;
            const min = range.min ? range.min : 0;
            const max = range.max ? range.max : 100;
            const newVal = Number(((val - min) * 100) / (max - min));
            bubble.innerHTML = val;

            // Sorta magic numbers based on size of the native UI thumb
            bubble.style.left = `calc(${newVal}% + (${19 - newVal * 0.38}px))`;
        }
        function showBubble(bubble, value) {
            bubble.style.display = !value ? "none" : "";
        }
    </script>

    <!-- Save URLs Modal -->
    <div class="modal fade" id="addSavedModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <label for="addSavedInput" class="form-label">URLs to add</label>
                    <textarea name="addSavedInput" id="addSavedInput" class="form-control" style="min-width: 100%; resize: vertical; max-height: 400px; min-height: 100px; white-space: nowrap;"></textarea>
                    <small>One URL per line</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addSavedSubmit">Add</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function(){
            $("#addSaved").click(function(){
                $("#addSavedModal").modal('show');
                $("#addSavedInput").val("");
            });
            $("#addSavedModal").on("shown.bs.modal", function(){
                $("#addSavedInput").focus();
            });
            $("#addSavedSubmit").click(function(){
                if($("#addSavedInput").val().trim().length > 0){
                    $("#addSavedModal").modal('hide');
                    ws.send(JSON.stringify({
                        event: 'save',
                        add: $("#addSavedInput").val().split("\n"),
                        parent: CurrentFolder
                    }));
                }
            });
        });
    </script>

    <!-- Add Folder Modal -->
    <div class="modal fade" id="addFolderModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <label for="addFolderInput" class="form-label">Folder name</label>
                    <input type="text" name="addFolderInput" id="addFolderInput" class="form-control">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addFolderSubmit">Add</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function(){
            $("#addFolder").click(function(){
                $("#addFolderModal").modal('show');
                $("#addFolderInput").val("");
            });
            $("#addFolderModal").on("shown.bs.modal", function(){
                $("#addFolderInput").focus();
            });
            $("#addFolderSubmit").click(function(){
                if($("#addFolderInput").val().trim().length > 0){
                    $("#addFolderModal").modal('hide');
                    ws.send(JSON.stringify({
                        event: 'save',
                        folder: true,
                        add: $("#addFolderInput").val(),
                        parent: CurrentFolder
                    }));
                }
            });
        });
    </script>

    <!-- Edit Track Modal -->
    <div class="modal fade" id="trackEditModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <label for="trackEditInput" class="form-label">New name</label>
                    <input type="text" name="trackEditInput" id="trackEditInput" class="form-control">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="trackEditSubmit">Save</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function(){
            $("#saved-page").on("click",".trackEdit",function(){
                $("#trackEditModal").modal('show');
                $("#trackEditInput").val($($(this).parents(".trackInfo")).find(".trackName").text());
                $("#trackEditInput").data("id",$($(this).parents(".trackInfo")).data("id"));
            });
            $("#trackEditModal").on("shown.bs.modal", function(){
                $("#trackEditInput").focus();
            });
            $("#trackEditSubmit").click(function(){
                if($("#trackEditInput").val().trim().length > 0){
                    $("#trackEditModal").modal('hide');
                    ws.send(JSON.stringify({
                        event: 'trackEdit',
                        name: $("#trackEditInput").val(),
                        id: $("#trackEditInput").data("id")
                    }));
                }
            });
        });
    </script>

    <!-- Add to Queue Modal -->
    <div class="modal fade" id="addQueueModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <label for="addQueueInput" class="form-label">URL to add</label>
                    <input type="text" name="addQueueInput" id="addQueueInput" class="form-control">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addQueueSubmit">Add</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function(){
            $("#clearQueue").click(function(){
                ws.send(JSON.stringify({
                    event: 'queue',
                    remove: "all"
                }));
            });
            $("#addQueue").click(function(){
                $("#addQueueModal").modal('show');
                $("#addQueueInput").val("");
            });
            $("#addQueueModal").on("shown.bs.modal", function(){
                $("#addQueueInput").focus();
            });
            $("#addQueueSubmit").click(function(){
                if($("#addQueueInput").val().trim().length > 0){
                    $("#addQueueModal").modal('hide');
                    const event = {
                        event: 'queue',
                        add: $("#addQueueInput").val()
                    };
                    LastEvent = event;
                    ws.send(JSON.stringify(event));
                }
            });
        });
    </script>

    <!-- Select Channel Modal -->
    <div class="modal fade" id="selectChannelModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="selectServerInput" class="form-label">Server</label>
                        <select name="selectServerInput" id="selectServerInput" class="form-select">
                            <option value="" selected disabled>Select a server</option>
                        </select>
                    </div>
                    <div id="selectChannelGroup" style="display: none;">
                        <label for="selectChannelInput" class="form-label">Channel</label>
                        <select name="selectChannelInput" id="selectChannelInput" class="form-select">
                            <option value="" selected disabled>Select a channel</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="selectChannelSubmit" disabled>Start</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function(){
            $("#selectChannelModal").on("shown.bs.modal", function(){
                $("#selectServerInput").focus();
            });
            $("#selectServerInput").change(function(){
                $("#selectChannelInput").html(`<option value="" selected disabled>Select a channel</option>`);
                const channels = ChannelList[$(this).val()]['channels'];
                for (let index = 0; index < channels.length; index++) {
                    const channel = channels[index];
                    $("#selectChannelInput").append($(`<option value="${channel.id}">${channel.name}</option>`));
                }
                $("#selectChannelGroup").show();
            });
            $("#selectChannelInput").change(function(){
                $("#selectChannelSubmit").prop("disabled",$("#selectChannelInput").val().trim().length == 0);
            });
            $("#selectChannelSubmit").click(function(){
                if($("#selectChannelInput").val().trim().length > 0){
                    $("#selectChannelModal").modal('hide');
                    LastEvent['channel'] = $("#selectChannelInput").val();
                    ws.send(JSON.stringify(LastEvent));
                }
            });
        });
    </script>

    <!-- WebSocket error Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="wsToast" class="toast text-bg-danger" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header text-white">
            <strong class="me-auto header-text">WebSocket error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            Hello World
          </div>
        </div>
    </div>
</body>
</html>